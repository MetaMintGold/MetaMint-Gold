<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMint | Master Admin Control</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #ef4444; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 15px; margin: 0; display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: var(--card); border-bottom: 3px solid var(--primary); border-radius: 15px; margin-bottom: 20px; }
        .search-box { display: flex; gap: 10px; background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #334155; }
        .search-box input { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 1rem; }
        .section-title { color: var(--primary); font-size: 0.9rem; font-weight: bold; text-transform: uppercase; margin: 25px 0 15px 5px; display: flex; align-items: center; gap: 10px; }
        .data-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .txid-text { font-size: 0.65rem; color: #38bdf8; word-break: break-all; margin-top: 5px; display: block; background: #0f172a; padding: 5px; border-radius: 4px; }
        .btn-manage { background: #38bdf8; color: #0f172a; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .swal-label { display: block; text-align: left; color: #94a3b8; font-size: 0.75rem; margin-top: 10px; margin-left: 10%; }
        .swal-input-custom { background: #0f172a !important; color: white !important; width: 80% !important; padding: 10px !important; border-radius: 8px !important; border: 1px solid #334155 !important; margin-bottom: 5px !important; }
    </style>
</head>
<body>
    <header class="header">
        <div><h2 style="margin:0;"><i class="fas fa-user-shield"></i> MASTER CONTROL</h2></div>
        <div id="adminMail" style="font-size: 0.7rem; color: #94a3b8;"></div>
    </header>

    <div class="search-box">
        <input type="number" id="searchUID" placeholder="Enter User UID">
        <button onclick="window.searchUser()" style="background:var(--primary); border:none; color:white; padding:10px 18px; border-radius:8px;"><i class="fas fa-search"></i></button>
    </div>

    <div class="section-title"><i class="fas fa-wallet"></i> Pending Deposits</div>
    <div id="depositList"></div>

    <div class="section-title"><i class="fas fa-hand-holding-usd"></i> Pending Withdrawals</div>
    <div id="withdrawList"></div>

    <div class="section-title"><i class="fas fa-users"></i> All Users</div>
    <div id="userList"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDea-7DWbKSc7QCbp2aP4OJuMiMvqnJxRA",
            authDomain: "metamint-127ee.firebaseapp.com",
            databaseURL: "https://metamint-127ee-default-rtdb.firebaseio.com",
            projectId: "metamint-127ee",
            storageBucket: "metamint-127ee.firebasestorage.app",
            messagingSenderId: "756801996954",
            appId: "1:756801996954:web:bcb7a18a57daacd3c6b723"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === "dreamsagweb@gmail.com") {
                document.body.style.display = "block";
                document.getElementById('adminMail').innerText = user.email;
                loadData();
            } else { window.location.href = 'dashboard.html'; }
        });

        function loadData() {
            // Deposits Fetching
            onValue(ref(db, 'depositRequests'), snap => {
                const div = document.getElementById('depositList');
                div.innerHTML = '';
                if(!snap.exists()) { div.innerHTML = '<p style="padding:10px; color:#64748b;">No pending deposits</p>'; return; }
                snap.forEach(child => {
                    const d = child.val();
                    div.innerHTML += `<div class="data-card"><div style="width:70%;"><b>$${d.amount}</b><br><small>UID: ${d.uid}</small><span class="txid-text">TXID: ${d.txid}</span></div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="approveDeposit('${child.key}', '${d.uid}', ${d.amount}, '${d.trxKey || ''}')" style="background:#22c55e; border:none; padding:10px; border-radius:5px; color:white;"><i class="fas fa-check"></i></button>
                        <button onclick="rejectDeposit('${child.key}', '${d.uid}', '${d.trxKey || ''}')" style="background:#ef4444; border:none; padding:10px; border-radius:5px; color:white;"><i class="fas fa-times"></i></button>
                    </div></div>`;
                });
            });

            // Withdrawals Fetching
            onValue(ref(db, 'admin/withdrawals'), snap => {
                const div = document.getElementById('withdrawList');
                div.innerHTML = '';
                if(!snap.exists()) { div.innerHTML = '<p style="padding:10px; color:#64748b;">No pending withdrawals</p>'; return; }
                snap.forEach(child => {
                    const w = child.val();
                    div.innerHTML += `<div class="data-card"><div style="width:70%;"><b>$${w.amount}</b><br><small>${w.username} (UID: ${w.uid})</small><span class="txid-text">Addr: ${w.address}</span></div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="processWithdraw('${child.key}', '${w.uid}', ${w.amount}, 'approved', '${w.trxKey || ''}')" style="background:#22c55e; border:none; padding:10px; border-radius:5px; color:white;"><i class="fas fa-check"></i></button>
                        <button onclick="processWithdraw('${child.key}', '${w.uid}', ${w.amount}, 'rejected', '${w.trxKey || ''}')" style="background:#ef4444; border:none; padding:10px; border-radius:5px; color:white;"><i class="fas fa-times"></i></button>
                    </div></div>`;
                });
            });

            // Users List Fetching
            onValue(ref(db, 'users'), snap => {
                const list = document.getElementById('userList');
                list.innerHTML = '';
                snap.forEach(c => {
                    const u = c.val();
                    list.innerHTML += `<div class="data-card"><div><b>${u.username}</b><br><small>UID: ${u.uid}</small></div>
                    <button onclick="window.openManager('${c.key}')" class="btn-manage">Manage</button></div>`;
                });
            });
        }

        // Fix 1: Deposit Approval with History Sync
        window.approveDeposit = async (key, uid, amount, trxKey) => {
            const userRef = ref(db, `users/${uid}`);
            const uSnap = await get(userRef);
            if(uSnap.exists()){
                const currentBal = uSnap.val().totalBalance || 0;
                await update(userRef, { totalBalance: currentBal + amount });
                
                // User ki history mein status 'SUCCESS' karo
                if(trxKey) {
                    await update(ref(db, `users/${uid}/transactions/${trxKey}`), { status: 'SUCCESS' });
                }
                
                await remove(ref(db, `depositRequests/${key}`));
                Swal.fire('Approved!', 'User balance updated and history synced.', 'success');
            }
        };

        // Fix 2: Deposit Rejection with History Sync
        window.rejectDeposit = async (key, uid, trxKey) => {
            if(trxKey) {
                await update(ref(db, `users/${uid}/transactions/${trxKey}`), { status: 'REJECTED' });
            }
            await remove(ref(db, `depositRequests/${key}`));
            Swal.fire('Rejected', 'Deposit request rejected and history updated.', 'error');
        };

        // Fix 3: Withdrawal Processing with History Sync
        window.processWithdraw = async (key, uid, amount, status, trxKey) => {
            const userRef = ref(db, `users/${uid}`);
            
            // Refund logic for rejected withdrawals
            if(status === 'rejected') {
                const uSnap = await get(userRef);
                if(uSnap.exists()) {
                    const currentWith = uSnap.val().withdrawable || 0;
                    await update(userRef, { withdrawable: currentWith + amount });
                }
            }

            // User ki history mein status update karo (APPROVED/REJECTED)
            if(trxKey) {
                await update(ref(db, `users/${uid}/transactions/${trxKey}`), { 
                    status: status.toUpperCase() 
                });
            }

            await update(userRef, { 
                notification: status === 'approved' ? `Your withdrawal of $${amount} has been approved!` : `Withdrawal of $${amount} was rejected and funds returned.`,
                lastNotifSeen: false
            });

            await remove(ref(db, `admin/withdrawals/${key}`));
            Swal.fire('Success', `Withdrawal ${status.toUpperCase()} and history synced.`, 'success');
        };

        // User Management Popup
        window.openManager = async (userKey) => {
            const u = (await get(ref(db, `users/${userKey}`))).val();
            const { value: form } = await Swal.fire({
                title: `Manage: ${u.username}`,
                html: `
                    <label class="swal-label">Deposit Balance ($)</label><input id="m-dep" class="swal2-input swal-input-custom" type="number" value="${u.totalBalance || 0}">
                    <label class="swal-label">Withdrawable Balance ($)</label><input id="m-with" class="swal2-input swal-input-custom" type="number" value="${u.withdrawable || 0}">
                    <label class="swal-label">Team Members</label><input id="m-team" class="swal2-input swal-input-custom" type="number" value="${u.teamCount || 0}">
                    <label class="swal-label">Push Notification</label><input id="m-note" class="swal2-input swal-input-custom" value="${u.notification || ''}">
                `,
                confirmButtonText: 'Save Changes',
                preConfirm: () => ({
                    totalBalance: parseFloat(document.getElementById('m-dep').value),
                    withdrawable: parseFloat(document.getElementById('m-with').value),
                    teamCount: parseInt(document.getElementById('m-team').value),
                    notification: document.getElementById('m-note').value,
                    lastNotifSeen: false
                })
            });
            if(form) { await update(ref(db, `users/${userKey}`), form); Swal.fire('Updated!', 'All data saved.', 'success'); }
        };

        window.searchUser = async () => {
            const inputUID = document.getElementById('searchUID').value;
            const snap = await get(ref(db, 'users'));
            let foundKey = null;
            snap.forEach(c => { if(String(c.val().uid) === String(inputUID)) foundKey = c.key; });
            if(foundKey) window.openManager(foundKey);
            else Swal.fire('Error', 'User not found', 'error');
        };
    </script>
</body>
</html>
