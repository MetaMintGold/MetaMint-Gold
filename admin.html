<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaMint | Master Admin Control</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #ef4444; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 15px; margin: 0; display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: var(--card); border-bottom: 3px solid var(--primary); border-radius: 15px; margin-bottom: 20px; }
        .search-box { display: flex; gap: 10px; background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #334155; }
        .search-box input { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 1rem; }
        .section-title { color: var(--primary); font-size: 0.9rem; font-weight: bold; text-transform: uppercase; margin: 25px 0 15px 5px; display: flex; align-items: center; gap: 10px; }
        .data-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .btn-manage { background: #38bdf8; color: #0f172a; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .swal2-input, .swal2-select { background: #0f172a !important; color: white !important; margin: 10px auto !important; width: 90% !important; border-radius: 8px !important; border: 1px solid #334155 !important; }
        .swal2-label { color: #94a3b8 !important; text-align: left; display: block; width: 90%; margin: 5px auto 0 auto; font-size: 0.8rem; }
        .empty-msg { color: #475569; text-align: center; padding: 20px; font-style: italic; font-size: 0.9rem; }
    </style>
</head>
<body>
    <header class="header">
        <div><h2 style="margin:0;"><i class="fas fa-user-shield"></i> MASTER CONTROL</h2></div>
        <div id="adminMail" style="font-size: 0.7rem; color: #94a3b8;"></div>
    </header>

    <div class="search-box">
        <input type="number" id="searchUID" placeholder="Enter User UID (e.g. 2749)">
        <button onclick="window.searchUser()" style="background:var(--primary); border:none; color:white; padding:10px 18px; border-radius:8px;"><i class="fas fa-search"></i></button>
    </div>

    <div class="section-title"><i class="fas fa-wallet"></i> Pending Deposits</div>
    <div id="depositList"><div class="empty-msg">Syncing...</div></div>

    <div class="section-title"><i class="fas fa-hand-holding-usd"></i> Pending Withdrawals</div>
    <div id="withdrawList"><div class="empty-msg">Syncing...</div></div>

    <div class="section-title"><i class="fas fa-users"></i> All Users</div>
    <div id="userList"><div class="empty-msg">Loading users...</div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDea-7DWbKSc7QCbp2aP4OJuMiMvqnJxRA",
            authDomain: "metamint-127ee.firebaseapp.com",
            databaseURL: "https://metamint-127ee-default-rtdb.firebaseio.com",
            projectId: "metamint-127ee",
            storageBucket: "metamint-127ee.firebasestorage.app",
            messagingSenderId: "756801996954",
            appId: "1:756801996954:web:bcb7a18a57daacd3c6b723"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === "dreamsagweb@gmail.com") {
                document.body.style.display = "block";
                const mailDiv = document.getElementById('adminMail');
                if(mailDiv) mailDiv.innerText = user.email; // Error handling
                loadData();
            } else { 
                window.location.href = 'dashboard.html'; 
            }
        });

        function loadData() {
            // Load Deposits
            onValue(ref(db, 'deposits'), snap => {
                const div = document.getElementById('depositList');
                if(!div) return;
                div.innerHTML = '';
                if(!snap.exists()) { div.innerHTML = '<div class="empty-msg">No pending deposits</div>'; return; }
                snap.forEach(child => {
                    const d = child.val();
                    div.innerHTML += `<div class="data-card"><div><b>$${d.amount}</b><br><small>UID: ${d.uid}</small></div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="approveTransaction('deposits', '${child.key}', '${d.userUid}', ${d.amount}, '${d.historyKey}')" style="background:#22c55e; border:none; padding:8px; border-radius:5px; color:white;"><i class="fas fa-check"></i></button>
                        <button onclick="deleteReq('deposits', '${child.key}')" style="background:#ef4444; border:none; padding:8px; border-radius:5px; color:white;"><i class="fas fa-times"></i></button>
                    </div></div>`;
                });
            });

            // Load Withdrawals
            onValue(ref(db, 'withdrawals'), snap => {
                const div = document.getElementById('withdrawList');
                if(!div) return;
                div.innerHTML = '';
                if(!snap.exists()) { div.innerHTML = '<div class="empty-msg">No pending withdrawals</div>'; return; }
                snap.forEach(child => {
                    const w = child.val();
                    div.innerHTML += `<div class="data-card"><div><b>$${w.amount}</b><br><small>UID: ${w.uid}</small></div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="approveWithdrawal('${child.key}', '${w.userUid}', ${w.amount}, '${w.historyKey}')" style="background:#22c55e; border:none; padding:8px; border-radius:5px; color:white;"><i class="fas fa-check"></i></button>
                        <button onclick="deleteReq('withdrawals', '${child.key}')" style="background:#ef4444; border:none; padding:8px; border-radius:5px; color:white;"><i class="fas fa-trash"></i></button>
                    </div></div>`;
                });
            });

            // Load Users
            onValue(ref(db, 'users'), snap => {
                const list = document.getElementById('userList');
                if(!list) return;
                list.innerHTML = '';
                snap.forEach(c => {
                    const u = c.val();
                    list.innerHTML += `<div class="data-card"><div><b>${u.username}</b><br><small>UID: ${u.uid || 'undefined'}</small></div>
                    <button onclick="window.openManager('${c.key}')" class="btn-manage">Manage</button></div>`;
                });
            });
        }

        window.searchUser = async () => {
            const inputUID = document.getElementById('searchUID').value;
            if(!inputUID) return;
            const snap = await get(ref(db, 'users'));
            let foundKey = null;
            snap.forEach(c => { if(String(c.val().uid) === String(inputUID)) foundKey = c.key; });
            if(foundKey) window.openManager(foundKey);
            else Swal.fire('Error', 'User not found', 'error');
        };

        window.openManager = async (userKey) => {
            const u = (await get(ref(db, `users/${userKey}`))).val();
            const { value: form } = await Swal.fire({
                title: `Manage: ${u.username}`,
                html: `
                    <label class="swal2-label">Deposit Balance ($)</label><input id="m-dep" class="swal2-input" type="number" value="${u.totalBalance || 0}">
                    <label class="swal2-label">Withdrawable Balance ($)</label><input id="m-with" class="swal2-input" type="number" value="${u.withdrawable || 0}">
                    <label class="swal2-label">Team Members (Count)</label><input id="m-team" class="swal2-input" type="number" value="${u.teamCount || 0}">
                    <label class="swal2-label">Team Reward ($)</label><input id="m-trew" class="swal2-input" type="number" value="${u.teamReward || 0}">
                    <label class="swal2-label">Account Status</label>
                    <select id="m-status" class="swal2-select">
                        <option value="Active" ${u.status === 'Active' ? 'selected' : ''}>Active</option>
                        <option value="Blocked" ${u.status === 'Blocked' ? 'selected' : ''}>Blocked</option>
                    </select>
                    <label class="swal2-label">Push Notification</label><input id="m-note" class="swal2-input" value="${u.notification || ''}">
                `,
                confirmButtonText: 'Update User',
                preConfirm: () => ({
                    totalBalance: parseFloat(document.getElementById('m-dep').value),
                    withdrawable: parseFloat(document.getElementById('m-with').value),
                    teamCount: parseInt(document.getElementById('m-team').value),
                    teamReward: parseFloat(document.getElementById('m-trew').value),
                    status: document.getElementById('m-status').value,
                    notification: document.getElementById('m-note').value,
                    lastNotifSeen: false
                })
            });
            if(form) { await update(ref(db, `users/${userKey}`), form); Swal.fire('Success', 'User data updated', 'success'); }
        };

        window.approveTransaction = async (path, key, userUid, amount, historyKey) => {
            const userRef = ref(db, `users/${userUid}`);
            const uSnap = await get(userRef);
            if(uSnap.exists()){
                const currentBal = uSnap.val().totalBalance || 0;
                await update(userRef, { totalBalance: currentBal + amount });
                if(historyKey) await update(ref(db, `user_history/${userUid}/${historyKey}`), { status: 'COMPLETED' });
                await remove(ref(db, `${path}/${key}`));
                Swal.fire('Approved!', 'Deposit completed', 'success');
            }
        };

        window.approveWithdrawal = async (key, userUid, amount, historyKey) => {
            if(historyKey) await update(ref(db, `user_history/${userUid}/${historyKey}`), { status: 'COMPLETED' });
            await remove(ref(db, `withdrawals/${key}`));
            Swal.fire('Withdrawn!', 'Withdrawal marked as completed', 'success');
        };

        window.deleteReq = async (path, key) => {
            const result = await Swal.fire({ title: 'Are you sure?', text: "Do you want to delete this request?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Yes, delete it!' });
            if (result.isConfirmed) {
                await remove(ref(db, `${path}/${key}`));
                Swal.fire('Deleted!', 'Request has been removed.', 'success');
            }
        };
    </script>
</body>
</html>
