<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MetaMint | My Team & Rewards</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        .dash-header { padding: 20px; background: #1e293b; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #334155; }
        .back-btn { font-size: 1.2rem; cursor: pointer; color: #38bdf8; margin-right: 15px; }
        .team-container { padding: 20px; margin-bottom: 120px; }
        
        /* Referral Card */
        .ref-card { background: #1e293b; border-radius: 20px; padding: 25px; text-align: center; border: 1px solid #334155; margin-bottom: 20px; }
        .ref-code { color: #38bdf8; font-size: 2.5rem; margin: 10px 0; letter-spacing: 3px; font-weight: 800; font-family: 'monospace'; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #1e293b; padding: 15px; border-radius: 15px; border: 1px solid #334155; text-align: center; }
        .stat-box h2 { margin: 5px 0; font-size: 1.5rem; color: #fff; }
        .stat-box p { margin: 0; font-size: 0.75rem; color: #94a3b8; }

        /* New Motivational Instruction Box */
        .reward-info-card { 
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%); 
            border: 1px solid rgba(56, 189, 248, 0.3); 
            border-radius: 20px; padding: 20px; margin-bottom: 25px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .reward-info-card h3 { color: #38bdf8; margin: 0 0 10px 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .reward-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; margin-bottom: 8px; border-left: 4px solid #38bdf8; }
        .reward-item span { font-size: 0.85rem; color: #cbd5e1; }
        .reward-amount { color: #22c55e; font-weight: bold; font-size: 1rem; }
        .promo-text { font-size: 0.8rem; color: #94a3b8; text-align: center; margin-top: 15px; line-height: 1.4; font-style: italic; }

        /* Table Styles */
        .team-table-card { background: #1e293b; border-radius: 15px; border: 1px solid #334155; overflow: hidden; }
        .team-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .team-table th { text-align: left; color: #64748b; padding: 15px; background: rgba(255,255,255,0.02); border-bottom: 1px solid #334155; }
        .team-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        .status-active { color: #22c55e; font-weight: bold; background: rgba(34, 197, 94, 0.1); padding: 4px 8px; border-radius: 5px; font-size: 0.7rem; }
        .status-inactive { color: #ef4444; font-weight: bold; background: rgba(239, 68, 68, 0.1); padding: 4px 8px; border-radius: 5px; font-size: 0.7rem; }
        
        .main-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
        .copy-btn { background: #38bdf8; color: #0f172a; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #1e293b; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #334155; }
        .nav-item { color: #64748b; text-decoration: none; text-align: center; font-size: 0.7rem; flex: 1; }
        .nav-item i { display: block; font-size: 1.2rem; margin-bottom: 3px; }
        .nav-item.active { color: #38bdf8; }
    </style>
</head>
<body>

    <header class="dash-header">
        <div style="display: flex; align-items: center;">
            <i class="fas fa-arrow-left back-btn" onclick="window.location.href='dashboard.html'"></i>
            <h2 style="margin: 0; font-size: 1.1rem; color: #38bdf8;">My Team Network</h2>
        </div>
    </header>

    <div class="team-container">
        <div class="ref-card">
            <p style="font-size: 0.85rem; color: #94a3b8; margin: 0;">Your Referral ID</p>
            <h1 id="myReferralCode" class="ref-code">----</h1>
            <button class="main-btn copy-btn" onclick="copyReferral()">
                <i class="fas fa-link"></i> Copy Referral Link
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <p>Total Members</p>
                <h2 id="totalTeamCount">0</h2>
            </div>
            <div class="stat-box">
                <p>Active Mining</p>
                <h2 id="activeCount" style="color: #22c55e;">0</h2>
            </div>
        </div>

        <div class="reward-info-card">
            <h3><i class="fas fa-gift"></i> Referral Rewards</h3>
            
            <div class="reward-item">
                <span>Plan 1 ($20) Activation</span>
                <span class="reward-amount">+$4.00 Reward</span>
            </div>
            
            <div class="reward-item">
                <span>Plan 2 ($60) Activation</span>
                <span class="reward-amount">+$15.00 Reward</span>
            </div>
            
            <div class="reward-item">
                <span>Plan 3 ($120) Activation</span>
                <span class="reward-amount">+$36.00 Reward</span>
            </div>

            <p class="promo-text">
                "Apna link copy karo aur doston ko share karo! Jitne zeyada log join karenge, utna zeyada reward aapke Dashboard Reward Box mein add hoga jahan se aap claim kar sakte hain."
            </p>
        </div>

        <div class="team-table-card">
            <h3 style="padding: 15px; margin: 0; font-size: 0.95rem; border-bottom: 1px solid #334155;">
                <i class="fas fa-users" style="color: #38bdf8;"></i> Team Composition
            </h3>
            <div style="overflow-x: auto;">
                <table class="team-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Status</th>
                            <th style="text-align: right;">Joined</th>
                        </tr>
                    </thead>
                    <tbody id="teamListBody">
                        <tr><td colspan="3" style="text-align: center; color: #64748b; padding: 30px;">Loading network...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="plans.html" class="nav-item"><i class="fas fa-gem"></i><span>Plans</span></a>
        <a href="deposit.html" class="nav-item"><i class="fas fa-wallet"></i><span>Deposit</span></a>
        <a href="team.html" class="nav-item active"><i class="fas fa-users"></i><span>Team</span></a>
        <a href="history.html" class="nav-item"><i class="fas fa-history"></i><span>History</span></a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDea-7DWbKSc7QCbp2aP4OJuMiMvqnJxRA",
            authDomain: "metamint-127ee.firebaseapp.com",
            databaseURL: "https://metamint-127ee-default-rtdb.firebaseio.com",
            projectId: "metamint-127ee",
            storageBucket: "metamint-127ee.firebasestorage.app",
            messagingSenderId: "756801996954",
            appId: "1:756801996954:web:bcb7a18a57daacd3c6b723"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const userRef = ref(db, 'users/' + user.uid);
                
                onValue(userRef, (snapshot) => {
                    const data = snapshot.val();
                    if(data) {
                        const myCode = data.referralCode || String(user.uid).substring(0, 6);
                        document.getElementById('myReferralCode').innerText = myCode;
                        fetchTeamMembers(myCode);
                    }
                });

                async function fetchTeamMembers(myCode) {
                    const usersRef = ref(db, 'users');
                    const teamQuery = query(usersRef, orderByChild('referredBy'), equalTo(myCode));
                    
                    onValue(teamQuery, (snapshot) => {
                        const listBody = document.getElementById('teamListBody');
                        listBody.innerHTML = '';
                        let totalCount = 0; 
                        let activeCount = 0;

                        if (snapshot.exists()) {
                            snapshot.forEach((child) => {
                                totalCount++;
                                const member = child.val();
                                const isPlanActive = member.miningStatus === 'active';
                                if (isPlanActive) activeCount++;
                                
                                const rawId = member.uid || child.key || "User";
                                const displayId = String(rawId).substring(0, 6);
                                
                                listBody.innerHTML += `
                                    <tr>
                                        <td style="font-family: monospace; color: #38bdf8;">#${displayId}</td>
                                        <td><span class="${isPlanActive ? 'status-active' : 'status-inactive'}">${isPlanActive ? 'Active' : 'Inactive'}</span></td>
                                        <td style="text-align: right; color: #64748b; font-size: 0.75rem;">${new Date(member.timestamp || Date.now()).toLocaleDateString([], {day:'2-digit', month:'short'})}</td>
                                    </tr>`;
                            });
                        } else {
                            listBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#64748b; padding:30px;">No network members.</td></tr>';
                        }
                        document.getElementById('totalTeamCount').innerText = totalCount;
                        document.getElementById('activeCount').innerText = activeCount;
                    });
                }
            } else { window.location.href = 'index.html'; }
        });

        window.copyReferral = function() {
            const code = document.getElementById('myReferralCode').innerText;
            if(code === "----") return;
            const link = window.location.origin + "/index.html?ref=" + code;
            navigator.clipboard.writeText(link).then(() => {
                Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Referral Link Copied!', showConfirmButton: false, timer: 1500 });
            });
        }
    </script>
</body>
</html>
